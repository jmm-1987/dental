{% extends "panel/base.html" %}

{% block panel_title %}Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/calendar.css') }}">
<style>
    /* Asegurar que el menú del panel no se vea afectado */
    .panel-nav {
        background-color: #fff !important;
        border-bottom: 2px solid #dee2e6 !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
        margin-bottom: 20px !important;
    }
    .panel-nav .nav {
        display: flex !important;
        align-items: center !important;
        flex-wrap: wrap !important;
        padding: 0 !important;
        margin: 0 !important;
        width: 100% !important;
    }
    .panel-nav .nav-link {
        color: #495057 !important;
        padding: 15px 20px !important;
        font-weight: 500 !important;
        border-bottom: 3px solid transparent !important;
        transition: all 0.3s !important;
        display: flex !important;
        align-items: center !important;
        gap: 8px !important;
        text-decoration: none !important;
    }
    .panel-nav .nav-link:hover {
        color: #0d6efd !important;
        background-color: #f8f9fa !important;
        border-bottom-color: #0d6efd !important;
    }
    .panel-nav .nav-link.active {
        color: #0d6efd !important;
        border-bottom-color: #0d6efd !important;
        background-color: #f8f9fa !important;
    }
</style>
{% endblock %}

{% block panel_content %}
<!-- Calendario Semanal -->
<div class="card shadow-sm">
    <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
        <h4 class="mb-0"><i class="bi bi-calendar-week"></i> Calendario Semanal</h4>
        <div class="btn-group" role="group">
            <button class="btn btn-outline-secondary" onclick="previousWeek()">
                <i class="bi bi-chevron-left"></i> Anterior
            </button>
            <button class="btn btn-primary" onclick="goToToday()">Hoy</button>
            <button class="btn btn-outline-secondary" onclick="nextWeek()">
                Siguiente <i class="bi bi-chevron-right"></i>
            </button>
        </div>
    </div>
    <div class="card-body p-0">
        <div id="calendar-container">
            <div class="calendar-header">
                <div class="calendar-time-col"></div>
                {% for i in range(7) %}
                <div class="calendar-day-header">
                    <div class="day-name" id="day-name-{{ i }}"></div>
                    <div class="day-date" id="day-date-{{ i }}"></div>
                </div>
                {% endfor %}
            </div>
            <div class="calendar-body" id="calendar-body">
                <!-- Se llenará con JavaScript -->
            </div>
        </div>
    </div>
</div>

<!-- Modal para crear cita -->
<div class="modal fade" id="modalNuevaCita" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nueva Cita</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formNuevaCita">
                    <input type="hidden" id="cita-start-time" name="start">
                    <input type="hidden" id="cita-end-time" name="end">
                    
                    <div class="mb-3">
                        <label class="form-label">Fecha y Hora</label>
                        <input type="text" class="form-control" id="cita-datetime" readonly>
                    </div>
                    
                    <div class="mb-3">
                        <label for="cita-patient-search" class="form-label">Paciente *</label>
                        <div class="position-relative">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="bi bi-search"></i>
                                </span>
                                <input type="text" class="form-control" id="cita-patient-search" placeholder="Buscar paciente..." autocomplete="off">
                                <input type="hidden" id="cita-patient" name="patient_id" required>
                                <button type="button" class="btn btn-success" id="btn-nuevo-paciente-calendar" data-bs-toggle="modal" data-bs-target="#modalNuevoPacienteCalendar" title="Crear nuevo paciente">
                                    <i class="bi bi-plus-lg"></i>
                                </button>
                            </div>
                            <div id="cita-patient-results" class="list-group position-absolute w-100" style="display: none; z-index: 1000; max-height: 300px; overflow-y: auto; margin-top: 2px;"></div>
                        </div>
                        <small class="form-text text-muted" id="cita-patient-selected-text"></small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="cita-dentist" class="form-label">Dentista *</label>
                        <select class="form-select" id="cita-dentist" name="dentist_id" required>
                            <option value="">Seleccionar dentista...</option>
                            {% for dentista in dentistas %}
                            <option value="{{ dentista.id }}">{{ dentista.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="cita-room" class="form-label">Sala/Sillón</label>
                        <select class="form-select" id="cita-room" name="room_id">
                            <option value="">Seleccionar sala...</option>
                            {% for sala in salas %}
                            <option value="{{ sala.id }}">{{ sala.nombre }}</option>
                            {% endfor %}
                        </select>
                        <input type="text" class="form-control mt-2" id="cita-sillon" name="sillon" placeholder="O especifica manualmente (opcional)">
                    </div>
                    
                    <div class="mb-3">
                        <label for="cita-motivo" class="form-label">Motivo</label>
                        <textarea class="form-control" id="cita-motivo" name="motivo" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveAppointment()">Guardar Cita</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para crear paciente rápido desde calendario -->
<div class="modal fade" id="modalNuevoPacienteCalendar" tabindex="-1" aria-labelledby="modalNuevoPacienteCalendarLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalNuevoPacienteCalendarLabel">
                    <i class="bi bi-person-plus"></i> Nuevo Paciente
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formNuevoPacienteCalendar">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="modal_calendar_nombre" class="form-label">Nombre *</label>
                            <input type="text" class="form-control" id="modal_calendar_nombre" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="modal_calendar_apellidos" class="form-label">Apellidos *</label>
                            <input type="text" class="form-control" id="modal_calendar_apellidos" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="modal_calendar_email" class="form-label">Email *</label>
                            <input type="email" class="form-control" id="modal_calendar_email" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="modal_calendar_telefono" class="form-label">Teléfono</label>
                            <input type="tel" class="form-control" id="modal_calendar_telefono">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="modal_calendar_dni" class="form-label">DNI/NIF</label>
                            <input type="text" class="form-control" id="modal_calendar_dni">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="modal_calendar_direccion" class="form-label">Dirección</label>
                            <input type="text" class="form-control" id="modal_calendar_direccion">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btn-guardar-paciente-calendar">
                    <i class="bi bi-check-circle"></i> Crear y seleccionar
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/calendar.js') }}"></script>
<script>
    // Actualizar currentWeekStart que ya está declarado en calendar.js
    currentWeekStart = new Date('{{ start_of_week.strftime("%Y-%m-%d") }}');
    const pacientes = {{ pacientes_json | tojson }};
    const dentistas = {{ dentistas_json | tojson }};
    const salas = {{ salas_json | tojson }};
    
    // Hacer salas disponible globalmente para otras funciones
    window.salas = salas || [];
    
    let searchTimeoutCalendar;
    let patientSearchHandler = null;
    
    // Seleccionar paciente en el calendario
    function selectPatientCalendar(id, nombreCompleto) {
        document.getElementById('cita-patient').value = id;
        document.getElementById('cita-patient-search').value = nombreCompleto;
        document.getElementById('cita-patient-selected-text').textContent = `Paciente seleccionado: ${nombreCompleto}`;
        document.getElementById('cita-patient-results').style.display = 'none';
    }
    
    // Función para inicializar la búsqueda de pacientes
    function initPatientSearch() {
        const searchInput = document.getElementById('cita-patient-search');
        if (!searchInput) {
            console.log('No se encontró el campo de búsqueda');
            return;
        }
        
        // Remover listener anterior si existe
        if (patientSearchHandler) {
            searchInput.removeEventListener('input', patientSearchHandler);
        }
        
        // Crear nuevo handler
        patientSearchHandler = function(e) {
            const query = e.target.value.trim();
            const resultsDiv = document.getElementById('cita-patient-results');
            
            clearTimeout(searchTimeoutCalendar);
            
            if (query.length < 2) {
                if (resultsDiv) {
                    resultsDiv.style.display = 'none';
                }
                return;
            }
            
            searchTimeoutCalendar = setTimeout(() => {
                console.log('Buscando pacientes con query:', query);
                fetch(`/panel/api/pacientes/buscar?q=${encodeURIComponent(query)}`)
                    .then(response => {
                        console.log('Respuesta recibida:', response.status);
                        if (!response.ok) {
                            throw new Error('Error en la respuesta del servidor: ' + response.status);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Datos recibidos:', data);
                        if (!resultsDiv) {
                            console.log('No se encontró el div de resultados');
                            return;
                        }
                        
                        resultsDiv.innerHTML = '';
                        
                        if (data.pacientes && data.pacientes.length > 0) {
                            console.log('Encontrados', data.pacientes.length, 'pacientes');
                            data.pacientes.forEach(paciente => {
                                const item = document.createElement('a');
                                item.className = 'list-group-item list-group-item-action';
                                item.href = '#';
                                item.innerHTML = `
                                    <div class="fw-bold">${paciente.nombre_completo}</div>
                                    <small class="text-muted">${paciente.email}${paciente.telefono ? ' | ' + paciente.telefono : ''}</small>
                                `;
                                item.addEventListener('click', function(e) {
                                    e.preventDefault();
                                    selectPatientCalendar(paciente.id, paciente.nombre_completo);
                                });
                                resultsDiv.appendChild(item);
                            });
                            resultsDiv.style.display = 'block';
                        } else {
                            console.log('No se encontraron pacientes');
                            resultsDiv.innerHTML = '<div class="list-group-item text-muted">No se encontraron pacientes</div>';
                            resultsDiv.style.display = 'block';
                        }
                    })
                    .catch(error => {
                        console.error('Error al buscar pacientes:', error);
                        if (resultsDiv) {
                            resultsDiv.innerHTML = '<div class="list-group-item text-danger">Error al buscar pacientes</div>';
                            resultsDiv.style.display = 'block';
                        }
                    });
            }, 300);
        };
        
        // Agregar listener
        searchInput.addEventListener('input', patientSearchHandler);
        console.log('Listener de búsqueda agregado');
    }
    
    // Ocultar resultados al hacer click fuera
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.position-relative')) {
            const resultsDiv = document.getElementById('cita-patient-results');
            if (resultsDiv) {
                resultsDiv.style.display = 'none';
            }
        }
    });
    
    // Crear paciente rápido desde calendario
    const btnGuardarPaciente = document.getElementById('btn-guardar-paciente-calendar');
    if (btnGuardarPaciente) {
        btnGuardarPaciente.addEventListener('click', function() {
        const data = {
            nombre: document.getElementById('modal_calendar_nombre').value,
            apellidos: document.getElementById('modal_calendar_apellidos').value,
            email: document.getElementById('modal_calendar_email').value,
            telefono: document.getElementById('modal_calendar_telefono').value,
            dni: document.getElementById('modal_calendar_dni').value,
            direccion: document.getElementById('modal_calendar_direccion').value
        };
        
        fetch('/panel/api/pacientes/crear-rapido', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Cerrar modal de nuevo paciente
                const modalPaciente = bootstrap.Modal.getInstance(document.getElementById('modalNuevoPacienteCalendar'));
                modalPaciente.hide();
                
                // Seleccionar el paciente creado
                selectPatientCalendar(data.paciente.id, data.paciente.nombre_completo);
                
                // Limpiar formulario del modal
                document.getElementById('formNuevoPacienteCalendar').reset();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al crear el paciente');
        });
        });
    }
    
    // Limpiar campo de búsqueda al abrir el modal e inicializar búsqueda
    const modalNuevaCita = document.getElementById('modalNuevaCita');
    if (modalNuevaCita) {
        modalNuevaCita.addEventListener('show.bs.modal', function() {
            const searchInput = document.getElementById('cita-patient-search');
            const patientInput = document.getElementById('cita-patient');
            const selectedText = document.getElementById('cita-patient-selected-text');
            const resultsDiv = document.getElementById('cita-patient-results');
            
            if (searchInput) searchInput.value = '';
            if (patientInput) patientInput.value = '';
            if (selectedText) selectedText.textContent = '';
            if (resultsDiv) resultsDiv.style.display = 'none';
            
            // Inicializar búsqueda cuando se muestra el modal (asegurarse de que el elemento existe)
            setTimeout(() => {
                initPatientSearch();
            }, 100);
        });
    }
    
    // Inicializar búsqueda cuando el DOM esté listo
    document.addEventListener('DOMContentLoaded', function() {
        loadCalendar();
        // Intentar inicializar inmediatamente
        initPatientSearch();
    });
</script>
{% endblock %}
