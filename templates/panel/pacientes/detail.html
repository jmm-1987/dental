{% extends "panel/base.html" %}

{% block panel_title %}{{ paciente.nombre_completo() }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/odontogram.css') }}">
<style>
    /* Asegurar que el menú del panel no se vea afectado */
    .panel-nav {
        background-color: #fff !important;
        border-bottom: 2px solid #dee2e6 !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
        margin-bottom: 20px !important;
    }
    .panel-nav .nav {
        display: flex !important;
        align-items: center !important;
        flex-wrap: wrap !important;
        padding: 0 !important;
        margin: 0 !important;
        width: 100% !important;
    }
    .panel-nav .nav-link {
        color: #495057 !important;
        padding: 15px 20px !important;
        font-weight: 500 !important;
        border-bottom: 3px solid transparent !important;
        transition: all 0.3s !important;
        display: flex !important;
        align-items: center !important;
        gap: 8px !important;
        text-decoration: none !important;
    }
    .panel-nav .nav-link:hover {
        color: #0d6efd !important;
        background-color: #f8f9fa !important;
        border-bottom-color: #0d6efd !important;
    }
    .panel-nav .nav-link.active {
        color: #0d6efd !important;
        border-bottom-color: #0d6efd !important;
        background-color: #f8f9fa !important;
    }
</style>
{% endblock %}

{% block panel_content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>{{ paciente.nombre_completo() }}</h1>
    <div>
        <a href="{{ url_for('panel.notification_new', patient_id=paciente.id) }}" class="btn btn-outline-primary">
            <i class="bi bi-envelope"></i> Enviar notificación
        </a>
    </div>
</div>

<!-- Tabs -->
<ul class="nav nav-tabs mb-4" id="patientTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info" type="button">
            Información
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="citas-tab" data-bs-toggle="tab" data-bs-target="#citas" type="button">
            Citas
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="historia-tab" data-bs-toggle="tab" data-bs-target="#historia" type="button">
            Historia Clínica
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="odontograma-tab" data-bs-toggle="tab" data-bs-target="#odontograma" type="button">
            Odontograma
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="tratamientos-tab" data-bs-toggle="tab" data-bs-target="#tratamientos" type="button">
            Tratamientos
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="facturas-tab" data-bs-toggle="tab" data-bs-target="#facturas" type="button">
            Facturas
        </button>
    </li>
</ul>

<div class="tab-content" id="patientTabsContent">
    <!-- Información -->
    <div class="tab-pane fade show active" id="info" role="tabpanel">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5>Datos Personales</h5>
                        <table class="table table-borderless">
                            <tr><th>Nombre:</th><td>{{ paciente.nombre }}</td></tr>
                            <tr><th>Apellidos:</th><td>{{ paciente.apellidos }}</td></tr>
                            <tr><th>Email:</th><td>{{ paciente.email }}</td></tr>
                            <tr><th>Teléfono:</th><td>{{ paciente.telefono or '-' }}</td></tr>
                            <tr><th>DNI:</th><td>{{ paciente.dni or '-' }}</td></tr>
                            <tr><th>Fecha de nacimiento:</th><td>{{ paciente.fecha_nacimiento.strftime('%d/%m/%Y') if paciente.fecha_nacimiento else '-' }}</td></tr>
                            <tr><th>Dirección:</th><td>{{ paciente.direccion or '-' }}</td></tr>
                            <tr><th>Fecha de alta:</th><td>{{ paciente.fecha_alta.strftime('%d/%m/%Y') }}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h5>Notas Generales</h5>
                        <p class="text-muted">{{ paciente.notas_generales or 'Sin notas' }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Citas -->
    <div class="tab-pane fade" id="citas" role="tabpanel">
        <div class="card">
            <div class="card-body">
                <a href="{{ url_for('panel.cita_new') }}?patient_id={{ paciente.id }}" class="btn btn-primary mb-3">
                    <i class="bi bi-plus-circle"></i> Nueva cita
                </a>
                {% if citas %}
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Fecha/Hora</th>
                                <th>Dentista</th>
                                <th>Motivo</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for cita in citas %}
                            <tr>
                                <td>{{ cita.fecha_hora_inicio.strftime('%d/%m/%Y %H:%M') }}</td>
                                <td>{{ cita.dentist.nombre }}</td>
                                <td>{{ cita.motivo or '-' }}</td>
                                <td>
                                    <span class="badge bg-{{ 'success' if cita.estado == 'confirmada' else 'warning' if cita.estado == 'programada' else 'secondary' }}">
                                        {{ cita.estado }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">No hay citas registradas.</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Historia Clínica -->
    <div class="tab-pane fade" id="historia" role="tabpanel">
        <div class="card">
            <div class="card-body">
                <a href="{{ url_for('panel.clinical_record_edit', patient_id=paciente.id) }}" class="btn btn-primary mb-3">
                    <i class="bi bi-pencil"></i> Editar historia clínica
                </a>
                {% if clinical_record %}
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <h6>Antecedentes Médicos</h6>
                        <p class="text-muted">{{ clinical_record.antecedentes_medicos or 'Sin antecedentes' }}</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <h6>Alergias</h6>
                        <p class="text-muted">{{ clinical_record.alergias or 'Sin alergias conocidas' }}</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <h6>Medicación</h6>
                        <p class="text-muted">{{ clinical_record.medicacion or 'Sin medicación' }}</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <h6>Observaciones Generales</h6>
                        <p class="text-muted">{{ clinical_record.observaciones_generales or 'Sin observaciones' }}</p>
                    </div>
                </div>
                {% else %}
                <p class="text-muted">No hay historia clínica registrada. <a href="{{ url_for('panel.clinical_record_edit', patient_id=paciente.id) }}">Crear una</a></p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Odontograma -->
    <div class="tab-pane fade" id="odontograma" role="tabpanel">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        {% if odontogram %}
                        <p class="text-muted mb-0">Última actualización: {{ odontogram.fecha.strftime('%d/%m/%Y') }}</p>
                        {% endif %}
                    </div>
                    <a href="{{ url_for('panel.odontogram_edit', patient_id=paciente.id) }}" class="btn btn-primary">
                        <i class="bi bi-pencil"></i> Editar odontograma
                    </a>
                </div>
                
                {% if odontogram %}
                    {% set datos_piezas = odontogram.get_datos() %}
                    {% if datos_piezas and datos_piezas|length > 0 %}
                        <!-- Visualización del odontograma -->
                        <div id="odontogram-view-container"></div>
                        {% if odontogram.notas %}
                        <div class="mt-3">
                            <h6>Notas:</h6>
                            <p class="text-muted">{{ odontogram.notas }}</p>
                        </div>
                        {% endif %}
                    {% else %}
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i> Odontograma creado pero sin datos registrados.
                        </div>
                    {% endif %}
                {% else %}
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> No hay odontograma registrado. 
                        <a href="{{ url_for('panel.odontogram_edit', patient_id=paciente.id) }}" class="alert-link">Crear uno</a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Tratamientos -->
    <div class="tab-pane fade" id="tratamientos" role="tabpanel">
        <div class="card">
            <div class="card-body">
                <a href="{{ url_for('panel.treatment_plans_list', patient_id=paciente.id) }}" class="btn btn-primary mb-3">
                    <i class="bi bi-plus-circle"></i> Nuevo plan de tratamiento
                </a>
                {% if treatment_plans %}
                <div class="list-group">
                    {% for plan in treatment_plans %}
                    <a href="{{ url_for('panel.treatment_plan_detail', plan_id=plan.id) }}" class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">{{ plan.descripcion_general or 'Plan de tratamiento' }}</h6>
                            <span class="badge bg-{{ 'success' if plan.estado == 'finalizado' else 'warning' if plan.estado == 'en_curso' else 'secondary' }}">
                                {{ plan.estado }}
                            </span>
                        </div>
                        <p class="mb-1">Dentista: {{ plan.dentist_user.nombre }}</p>
                        <small>Coste estimado: {{ "%.2f"|format(plan.coste_estimado) }} €</small>
                    </a>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted">No hay planes de tratamiento registrados.</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Facturas -->
    <div class="tab-pane fade" id="facturas" role="tabpanel">
        <div class="card">
            <div class="card-body">
                <a href="{{ url_for('panel.invoice_new', patient_id=paciente.id) }}" class="btn btn-primary mb-3">
                    <i class="bi bi-plus-circle"></i> Nueva factura
                </a>
                {% if invoices %}
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Total</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for factura in invoices %}
                            <tr>
                                <td>{{ factura.fecha_emision.strftime('%d/%m/%Y') }}</td>
                                <td>{{ "%.2f"|format(factura.total) }} €</td>
                                <td>
                                    <span class="badge bg-{{ 'success' if factura.estado_pago == 'pagado' else 'warning' if factura.estado_pago == 'parcial' else 'danger' }}">
                                        {{ factura.estado_pago }}
                                    </span>
                                </td>
                                <td>
                                    <a href="{{ url_for('panel.invoice_detail', invoice_id=factura.id) }}" class="btn btn-sm btn-outline-primary">
                                        Ver
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">No hay facturas registradas.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/tooth-svg.js') }}"></script>
<script src="{{ url_for('static', filename='js/odontogram-view.js') }}"></script>
{% if odontogram %}
<script>
    const odontogramData = {{ odontogram.get_datos() | tojson if odontogram.get_datos() else '{}' }};
    // Renderizar odontograma cuando se active la pestaña
    document.getElementById('odontograma-tab').addEventListener('shown.bs.tab', function() {
        renderOdontogramView(odontogramData, 'odontogram-view-container');
    });
    // Renderizar inmediatamente si la pestaña ya está activa
    if (document.getElementById('odontograma-tab').classList.contains('active')) {
        renderOdontogramView(odontogramData, 'odontogram-view-container');
    }
</script>
{% endif %}
{% endblock %}

